---
import { Icon } from "astro-icon/components";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

interface Props {
	id: string;
	name?: string;
	isCollapsed?: boolean;
	collapsedHeight?: string;
	class?: string;
	style?: string;
}
const { id, name, isCollapsed, collapsedHeight, style } = Astro.props;
const className = Astro.props.class;
---
<widget-layout data-id={id} data-is-collapsed={String(isCollapsed)} class={"pb-4 card-base " + className} style={style}>
    {id !== "sidebar-toc" && (
        <div class="widget-title font-bold transition text-lg text-[#394E6A] dark:text-neutral-100 relative ml-8 mt-4 mb-2
            before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
            before:absolute before:left-[-16px] before:top-[5.5px] flex items-center justify-between">
            <span class="widget-name">{name}</span>
            <slot name="title-icon" />
        </div>
    )}
    <div id={id} class:list={["collapse-wrapper px-4 overflow-hidden", {"collapsed": isCollapsed}]}>
        <slot></slot>
    </div>
    {isCollapsed && <div class="expand-btn px-4 -mb-2">
        <button class="btn-plain rounded-lg w-full h-9" data-more-text={i18n(I18nKey.more)} data-collapse-text={i18n(I18nKey.collapse)}>
            <div class="text-[var(--primary)] flex items-center justify-center gap-2 -translate-x-2">
                <Icon name="ri:arrow-down-s-line" class="text-[1.25rem] transition-transform duration-300"></Icon> 
                <span class="btn-text">{i18n(I18nKey.more)}</span>
            </div>
        </button>
    </div>}
</widget-layout>

<style define:vars={{ collapsedHeight }}>
    .collapsed {
        height: var(--collapsedHeight);
    }
</style>

<script>
    class WidgetLayout extends HTMLElement {
        constructor() {
            super();

            if (this.dataset.isCollapsed !== "true")
                return;

            const id = this.dataset.id;
            const btnWrapper = this.querySelector('.expand-btn');
            const btn = btnWrapper!.querySelector('button');
            const icon = btn!.querySelector('svg'); // Icon component renders as svg
            const textSpan = btn!.querySelector('.btn-text');
            const wrapper = this.querySelector(`#${id}`);

            btn!.addEventListener('click', () => {
                const isCollapsed = wrapper!.classList.contains('collapsed');
                
                if (isCollapsed) {
                    wrapper!.classList.remove('collapsed');
                    if (icon) icon.style.transform = 'rotate(180deg)';
                    if (textSpan) textSpan.textContent = btn!.dataset.collapseText || 'Collapse';
                } else {
                    wrapper!.classList.add('collapsed');
                    if (icon) icon.style.transform = 'rotate(0deg)';
                    if (textSpan) textSpan.textContent = btn!.dataset.moreText || 'More';
                }
            })
        }
    }

    if (!customElements.get("widget-layout")) {
        customElements.define("widget-layout", WidgetLayout);
    }
</script>
