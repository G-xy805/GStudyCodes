---
import type { CollectionEntry } from "astro:content";
import { getPostUrlBySlug } from "@utils/url-utils";
import { getPopularPosts } from "@/utils/content-utils";
import { Icon } from "astro-icon/components";
import WidgetLayout from "@/components/widget/WidgetLayout.astro";

const allPosts = await getPopularPosts();
const popularPosts = allPosts.slice(0, 5);

type PostEntry = CollectionEntry<"posts">;

interface Props {
  class?: string;
  style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;

// 简单的字数统计和阅读时间估算
function getReadingTime(content: string) {
  const wordsPerMinute = 200;
  const wordCount = content.length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return `${minutes} min`;
}

// 格式化日期
function formatDate(date: Date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
---

<WidgetLayout name="热门文章" id="popular-posts" class={className} style={style}>
  <div class="flex flex-col gap-4 pb-3">
    {popularPosts.length > 0 ? (
      popularPosts.map((post: PostEntry, index: number) => (
        <a 
          href={getPostUrlBySlug(post.id)} 
          class="group relative flex items-start gap-3 p-4 rounded-xl hover:bg-[var(--btn-plain-bg-hover)] transition-all duration-300 border border-transparent hover:border-[var(--line-divider)] hover-scale shadow-sm hover:shadow-md"
        >
          <!-- Rank Badge -->
          <div class={`flex-none flex flex-col items-center justify-center w-10 h-12 rounded-lg shadow-sm transition-all duration-300 transform group-hover:scale-105 ${
            index === 0 ? 'bg-gradient-to-br from-yellow-100 to-yellow-50 dark:from-yellow-900/30 dark:to-yellow-800/10 text-yellow-600 dark:text-yellow-400 border border-yellow-200/50 dark:border-yellow-700/30' :
            index === 1 ? 'bg-gradient-to-br from-slate-100 to-slate-50 dark:from-slate-700/30 dark:to-slate-800/10 text-slate-600 dark:text-slate-400 border border-slate-200/50 dark:border-slate-600/30' :
            index === 2 ? 'bg-gradient-to-br from-orange-100 to-orange-50 dark:from-orange-900/30 dark:to-orange-800/10 text-orange-600 dark:text-orange-400 border border-orange-200/50 dark:border-orange-700/30' :
            'bg-[var(--card-bg)] text-[var(--text-muted)] border border-[var(--line-divider)]'
          }`}>
            <span class="text-xs font-bold font-mono">{String(index + 1).padStart(2, '0')}</span>
            {index < 3 && <Icon name="ri:vip-crown-2-fill" class="w-3 h-3 opacity-70 mt-0.5 group-hover:scale-110 transition-transform duration-300" />}
          </div>
          
          <!-- Content -->
          <div class="flex-1 min-w-0 pt-0.5">
            <h3 
              class="text-base font-bold text-[var(--text-color)] group-hover:text-primary transition-colors line-clamp-2 leading-snug mb-2"
              title={post.data.title}
            >
              {post.data.title}
            </h3>
            
            <!-- Post Description -->
            {post.data.description && (
              <p class="text-xs text-[var(--text-secondary)] line-clamp-2 leading-relaxed mb-2 opacity-90 group-hover:opacity-100 transition-opacity">
                {post.data.description}
              </p>
            )}
            
            <div class="flex items-center flex-wrap gap-x-2 gap-y-1 text-xs">
              <!-- Reading Time -->
              <span class="flex items-center gap-1 text-[var(--text-muted)] opacity-80 group-hover:opacity-100 transition-opacity">
                <Icon name="ri:time-line" class="w-3 h-3" />
                {post.data.readingTime || getReadingTime(post.body)}
              </span>
              
              <!-- Date -->
              <span class="flex items-center gap-1 text-[var(--text-muted)] opacity-80 group-hover:opacity-100 transition-opacity">
                <Icon name="ri:calendar-line" class="w-3 h-3" />
                {formatDate(post.data.published)}
              </span>
              
              <!-- Category -->
              {post.data.category && (
                 <span class="flex items-center gap-1 text-[var(--primary)] bg-primary/5 px-1.5 py-0.5 rounded text-[10px] font-medium transition-all duration-300 group-hover:bg-primary/10">
                    <Icon name="ri:folder-line" class="w-2.5 h-2.5" />
                    {post.data.category}
                 </span>
              )}
              
              <!-- Tags -->
              {post.data.tags && post.data.tags.slice(0, 2).map((tag: string, tagIndex: number) => (
                <span key={tagIndex} class="flex items-center gap-1 text-[var(--text-secondary)] bg-[var(--bg-secondary)] px-1.5 py-0.5 rounded text-[10px] transition-all duration-300 group-hover:bg-[var(--bg-hover)]">
                  <Icon name="ri:price-tag-3-line" class="w-2.5 h-2.5" />
                  {tag}
                </span>
              ))}
            </div>
          </div>
        </a>
      ))
    ) : (
      <div class="p-8 text-center text-[var(--text-muted)] flex flex-col items-center gap-3 opacity-60">
        <Icon name="ri:inbox-line" class="w-10 h-10" />
        <span class="text-sm">暂无热门文章</span>
        <span class="text-xs opacity-80">创作更多精彩内容吧！</span>
      </div>
    )}
  </div>
</WidgetLayout>
